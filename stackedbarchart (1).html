<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stacked Bar Chart with D3.js</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <style>
        /* Add any additional styling you want for the chart here */
    </style>
</head>
<body>

<div>
    <label for="countryDropdown">Select Country:</label>
    <select id="countryDropdown"></select>
</div>

<div id="chart"></div>

<script>
    // Assuming your data is stored in a variable called 'data'
    // Replace 'data' with your actual variable name
    d3.csv('1- mental-illnesses-prevalence.csv', function(data){
        // Extract unique country names for the dropdown
        var countries = Array.from(new Set(data.map(d => d.Country)));

        // Populate the dropdown with country options
        var dropdown = d3.select('#countryDropdown');

        dropdown
            .selectAll('option')
            .data(countries)
            .enter()
            .append('option')
            .text(d => d)
            .attr('value', d => d);

        // Set initial country selection
        var selectedCountry = countries[0];

        // Filter data based on the selected country
        var filteredData = data.filter(d => d.Country === selectedCountry);

        // Set up chart dimensions
        var margin = { top: 20, right: 20, bottom: 30, left: 50 },
            width = 1000 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        // Set up scales
        var xScale = d3.scaleBand().range([0, width]).padding(0.1);
        var yScale = d3.scaleLinear().range([height, 0]);

        // Set up color scale for stacked bars
        var colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // Append an SVG element to the chart div
        var svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Format the data
        data.forEach(function (d) {
            d.Year = +d.Year;
            // Add more properties if needed for the stacked bars
            d.Schizophrenia = +d.Schizophrenia;
            d.Depressive = +d.Depressive;
            d.Anxiety = +d.Anxiety;
            d.Bipolar = +d.Bipolar;
            d['Eating disorder'] = +d['Eating disorder'];
        });

        // Update the filtered data when the dropdown selection changes
        dropdown.on('change', function () {
            selectedCountry = this.value;
            updateChart();
        });

        // Function to update the chart based on the selected country
        function updateChart() {
            filteredData = data.filter(d => d.Country === selectedCountry);
            redrawStackedBarChart();
        }

        // Function to remove existing chart elements and redraw the stacked bar chart
        function redrawStackedBarChart() {
            // Remove existing chart elements
            svg.selectAll(".bar-group").remove();
            svg.selectAll(".x-axis").remove();
            svg.selectAll(".y-axis").remove();

            // Redraw the stacked bar chart
            drawStackedBarChart();
        }

        // Function to draw the stacked bar chart
        function drawStackedBarChart() {
            // Set the domain of the scales
            xScale.domain(filteredData.map(d => d.Year));
            yScale.domain([0, d3.max(filteredData, function (d) {
                return d.Schizophrenia + d.Depressive + d.Anxiety + d.Bipolar + d['Eating disorder'];
            })]);

            // Create a stack generator
            var stack = d3.stack()
                .keys(['Schizophrenia', 'Depressive', 'Anxiety', 'Bipolar', 'Eating disorder'])
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetNone);

            // Generate the stacked data
            var stackedData = stack(filteredData);

            // Create groups for each stacked bar
            var groups = svg.selectAll("g.bar-group")
                .data(stackedData)
                .enter()
                .append("g")
                .attr("class", "bar-group")
                .style("fill", function (d) {
                    return colorScale(d.key);
                });
            
            // Create tooltip
            var tooltip = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("background-color", "white")
                .style("border", "1px solid black")
                .style("border-radius", "5px")
                .style("padding", "5px")
                .style("visibility", "hidden");

    

            // Create and append the stacked bars
            groups.selectAll("rect")
                .data(function (d) {
                    return d;
                })
                .enter()
                .append("rect")
                .attr("x", function (d) {
                    return xScale(d.data.Year);
                })
                .attr("y", function (d) {
                    return yScale(d[1]);
                })
                .attr("height", function (d) {
                    return yScale(d[0]) - yScale(d[1]);
                })
                .attr("width", xScale.bandwidth())
                .on("mouseover", function (d) {
                    tooltip.style("visibility", "visible");
                    tooltip.text("Year: " + d.data.Year +
                                "\nMental Disorder: " + d.data.value +
                                "\nValue: " + (d.data[d.value])); // Use d.data[d.key] to get the value
                })
                .on("mousemove", function () {
                    tooltip.style("top", (d3.event.pageY - 20) + "px")
                        .style("left", (d3.event.pageX + 20) + "px");
                })
                .on("mouseout", function () {
                    tooltip.style("visibility", "hidden");
                });

            // Create X-axis
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale));

            // Create Y-axis
            svg.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(yScale));
        }

        // Draw the initial stacked bar chart
        drawStackedBarChart();
    });
</script>

</body>
</html>
